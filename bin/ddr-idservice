#!/usr/bin/env python

#
# ddr-idservice
#

description = """Writes collection ID data to JSON for importing by idservice app."""

epilog = """
EXAMPLE

ddr-idservice /PATH/TO/ddr-test-123 /PATH/TO/COLLECTION.json

---"""


import argparse
import json
import logging
import sys

from DDR import config
from DDR import identifier
from DDR import util
from DDR import models

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s %(levelname)-8s %(message)s',
    stream=sys.stdout,
)


def main():

    parser = argparse.ArgumentParser(
        description=description,
        epilog=epilog,
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    parser.add_argument('collection', help='Path to collection.')
    parser.add_argument('path', help='Path to dumpfile.')
    args = parser.parse_args()

    ci = identifier.Identifier(args.collection)
    collection = ci.object()
    print(ci)
    print(collection)
    
    data = [
        {
            'id': i.id,
            'collection_id': ci.id,
            'model': i.model,
        }
        for i in collection.identifiers()
    ]
    
    with open(args.path, 'w') as f:
        f.write(json.dumps(data))


if __name__ == '__main__':
    main()
